<!-- /src/main/resources/templates/products/detail.html -->
<!DOCTYPE html>
<html lang="ko" translate="no" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:replace="~{_fragments/_head :: my-head('상품상세')}" />
    <link rel="stylesheet" th:href="@{/assets/css/product.css}" />
</head>
<body>
<th:block th:replace="~{_fragments/header}" />

<div class="container">
    <th:block th:replace="~{_fragments/sidebar}" />

        <div class="product-detail">
            <div class="product-header">
                <h1 class="product-category-title" th:text="${categoryName}" />
                <form method="get" class="search-form" th:action="@{/products/{categoryId}(categoryId=${categoryId})}">
                    <div class="search-input-container">
                        <i class="search-icon fa fa-search"></i>
                        <input type="text" name="keyword" placeholder="검색어 입력" th:value="${keyword}" />
                    </div>
                    <button type="submit">검색</button>
                </form>
            </div>

            <!-- 상품 상세 -->
            <div class="product-info">
                <!-- 상품 상세 이미지 -->
                <div class="product-detail-container">
                    <div class="product-main-image-section">
                        <img class="product-main-image"
                             th:src="${@fileHelper.getFileUrl(product.imageUrl)}" th:alt="${product.name}">
                    </div>

                    <!-- 상품 정보 -->
                    <div class="product-info-section">
                        <h1 class="product-title" th:text="${product.name}"></h1>
                        <div class="product-summary" th:text="${product.summary}"></div>

                        <!-- 가격 표시 -->
                        <div class="product-price-section">
                           <div th:if="${product.discount > 0}">
                                <div class="original-price" th:text="|₩${#numbers.formatInteger(product.price, 0, 'COMMA')}|"></div>
                                <div class="current-price">
                                    <span th:text="|₩${#numbers.formatInteger(product.price - (product.price * product.discount / 100), 0, 'COMMA')}|"></span>
                                    <span class="discount-rate" th:text="|${product.discount}% OFF|"></span>
                                </div>
                            </div>
                            <div th:unless="${product.discount > 0}">
                                <div class="current-price" th:text="|₩${#numbers.formatInteger(product.price, 0, 'COMMA')}|"></div>
                            </div>
                        </div>

                        <!-- 상품 옵션 -->
                        <div class="product-options" th:if="${product.options != null and !product.options.isEmpty()}">
                            <div class="option-group" th:each="entry : ${product.options}">
                                <label class="option-label" th:text="${entry.key}"></label>
                                <div class="option-values">
                                    <span class="option-value" th:each="option : ${entry.value}"
                                          th:text="${option.value}"
                                          th:data-option-id="${option.id}"
                                          th:data-option-name="${entry.key}"></span>
                                </div>
                            </div>
                        </div>

                        <!-- 조합 추가 버튼 -->
<!--                        <button type="button" class="add-combination-btn" id="addCombinationBtn">-->
<!--                            선택한 옵션 조합 추가(수량: 1개)-->
<!--                        </button>-->

                        <!-- 선택된 옵션 조합 -->
                        <div class="option-combinations" id="combinationList">
                        </div>

                        <!-- 총 주문 금액 -->
                        <div class="total-summary" id="totalSummary" style="display: none;">
                            <div class="total-summary-title">주문 정보</div>
                            <div class="total-summary-content">
                                <span class="total-quantity" id="totalQuantity">총 0개</span>
                                <span class="total-price" id="totalPrice">₩0</span>
                            </div>
                        </div>

                        <!-- 구매 버튼 -->
                        <div class="action-buttons">
                            <button type="button" class="btn-cart">장바구니 담기</button>
                            <button type="button" class="btn-buy">바로구매</button>

                    </div>
                </div>
            </div>

            <!-- 상품 상세 탭 -->
            <div class="product-tabs">
                <div class="tab-headers">
                    <div class="tab-header active" data-target="detail">상품상세</div>
                    <div class="tab-header" data-target="delivery">배송정보</div>
                </div>

                <div class="tab-content">
                    <div id="detail-tab" class="tab-pane active">
                        <!-- MD Comment 섹션-->
                        <div class="md-comment-section" th:if="${product.mdComment != null and !#strings.isEmpty(product.mdComment)}">
                            <div class="md-comment-title">MD's COMMENT</div>
                            <div class="md-comment-content" th:text="${product.mdComment}"></div>
                        </div>

                        <!-- 구분선 -->
                        <hr class="content-divider">

                        <!-- 상품 상세 내용 -->
                        <div class="product-content" th:utext="${#strings.replace(product.content, '&lt;img src=&quot;/products', '&lt;img src=&quot;/files/products')}"></div>
                    </div>

                    <div id="delivery-tab" class="tab-pane">
                        <div class="delivery-info" th:text="${product.deliveryInfo}"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block th:replace="~{_fragments/footer}" />


    <!-- JavaScript 변수 설정 및 초기화 -->
<!-- FetchHelper -->
<script th:src="@{/assets/js/FetchHelper.js}"></script>

<script th:inline="javascript">
    const productData = {
        id: [[${product.id}]],
        name: [[${product.name}]],
        price: [[${product.price}]],
        discount: [[${product.discount}]],
    };
</script>

<!-- 옵션 선택/검증/장바구니 담기 기능 통합 스크립트 -->
<script>
    // 선택된 옵션 저장
    window.selectedOptions = {};
    window.selectedOptionsString = "";

    // 옵션 클릭 시 선택/해제 처리
    document.querySelectorAll(".option-value").forEach(el => {
        el.addEventListener("click", () => {

            const optionName = el.dataset.optionName;   // 예: 색상
            const optionValue = el.textContent.trim();  // 예: 빨강

            // 같은 그룹에서 다른 것 선택하면 교체
            window.selectedOptions[optionName] = optionValue;

            // UI 강조
            el.parentElement.querySelectorAll(".option-value")
                .forEach(s => s.classList.remove("selected"));
            el.classList.add("selected");

            // 옵션 문자열로 변환
            window.selectedOptionsString =
                Object.entries(window.selectedOptions)
                    .map(([k, v]) => `${k}: ${v}`)
                    .join(", ");

            console.log("selectedOptionsString =", window.selectedOptionsString);
        });
    });

    // 옵션 선택 강제
    function validateOptionSelection() {
        const optionGroups = document.querySelectorAll(".option-group");

        if (optionGroups.length === 0) return true; // 옵션 없는 상품

        for (let group of optionGroups) {
            const optionName = group.querySelector(".option-label").textContent.trim();
            if (!window.selectedOptions[optionName]) {
                alert(`${optionName} 옵션을 선택해주세요.`);
                return false;
            }
        }
        return true;
    }

    // 장바구니 담기 버튼
    document.querySelector(".btn-cart").addEventListener("click", async () => {

        // 옵션 체크
        if (!validateOptionSelection()) return;

        const optionText = window.selectedOptionsString; // 선택된 옵션 문자열
        const quantity = 1;

        try {
            await fetchHelper.post("/api/cart/add", {
                productId: productData.id,
                optionText: optionText,
                quantity: quantity
            });

            alert("장바구니에 담겼습니다!");
            window.location.href = "/cart";

        } catch (err) {
            alert("장바구니 담기 실패: " + err.message);
        }
    });


</script>

<script>
    // 상품 상세 탭 전환 기능 복구
    document.querySelectorAll(".tab-header").forEach(tab => {
        tab.addEventListener("click", () => {
            const target = tab.dataset.target; // detail 또는 delivery

            // 탭 헤더 active 처리
            document.querySelectorAll(".tab-header")
                .forEach(th => th.classList.remove("active"));
            tab.classList.add("active");

            // 탭 콘텐츠 active 처리
            document.querySelectorAll(".tab-pane")
                .forEach(pane => pane.classList.remove("active"));

            document.querySelector(`#${target}-tab`).classList.add("active");
        });
    });
</script>

<style>
    /* 선택된 옵션 UI 강조 */
    .option-value.selected {
        border: 1px solid #e60023;
        padding: 4px 8px;
        border-radius: 4px;
        background: #ffecec;
    }
</style>


</body>
</html>
